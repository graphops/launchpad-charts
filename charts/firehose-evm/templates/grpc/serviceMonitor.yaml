{{- $componentName := "grpc" -}}
{{- $componentValues := deepCopy (index $.Values $componentName) -}}
{{- $commonValues := deepCopy $.Values.common -}}
{{- $values := fromYaml (include "utils.deepMerge" (list $commonValues $componentValues)) -}}
{{- if and $values.enabled $values.serviceMonitor.enabled -}}
{{- $defaultYaml := `
{{- $componentName := "grpc" -}}
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ include "firehose-evm.fullname" . }}-{{ $componentName }}
  labels:
    {{- include "firehose-evm.labels" . | nindent 4 }}
spec:
  jobLabel: {{ .Release.Name | quote }}
  selector:
    matchLabels:
      {{- include "firehose-evm.selectorLabels" . | nindent 6 }}
  namespaceSelector:
    matchNames:
      - {{ .Release.Namespace }}
  endpoints:
    - port: metrics-fh
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s
` -}}
{{- $defaultServiceMonitor := fromYaml (tpl $defaultYaml .) -}}

{{- $finalServiceMonitor := list $defaultServiceMonitor $values.serviceMonitor | include "firehose-evm.serviceMonitorConfig" -}}

{{- $finalServiceMonitor -}}
{{- end -}}
