# Default values for graph-network-indexer.
# This is a YAML-formatted file.

nameOverride: ""
fullnameOverride: ""

# -- Pull secrets required to fetch the Image
imagePullSecrets: []

serviceAccount:
  # -- Specifies whether a service account should be created
  create: true
  # -- Annotations to add to the service account
  annotations: {}
  # -- The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

prometheus:
  serviceMonitors:
    # -- Enable monitoring by creating `ServiceMonitor` CRDs ([prometheus-operator](https://github.com/prometheus-operator/prometheus-operator))
    enabled: false
    labels: {}
    interval:
    scrapeTimeout:
    relabelings: []

grafana:
  # -- Enable creation of Grafana dashboards. [Grafana chart](https://github.com/grafana/helm-charts/tree/main/charts/grafana#grafana-helm-chart) must be configured to search this namespace, see `sidecar.dashboards.searchNamespace`
  dashboards: false
  # -- Must match `sidecar.dashboards.label` value for the [Grafana chart](https://github.com/grafana/helm-charts/tree/main/charts/grafana#grafana-helm-chart)
  dashboardsConfigMapLabel: grafana_dashboard
  # -- Must match `sidecar.dashboards.labelValue` value for the [Grafana chart](https://github.com/grafana/helm-charts/tree/main/charts/grafana#grafana-helm-chart)
  dashboardsConfigMapLabelValue: "1"

# -- Value defaults that apply to both indexer-agent and indexer-service
indexerDefaults:
  # -- Config to be supplied as CLI arguments, specified using YAML keys to allow overriding
  config:
    # -- (required) URL for a blockchain node that has the Graph Protocol contracts (e.g. Ethereum Mainnet, Goerli)
    ethereum: null
    # -- Name of the network that you have specified a node URL for in `ethereum`
    ethereum-network: "mainnet"
    # -- (required) Ethereum address of your Indexer
    indexer-address: null
    # -- (required) URL for your graph node query endpoint (probably a load balancer address)
    graph-node-query-endpoint: null
    # -- (required) URL for your graph node status endpoint (probably a load balancer address)
    graph-node-status-endpoint: null
    # -- (required) Hostname for your Postgres indexer metadata database
    postgres-host: null
    # -- Name of the Postgres database to use for indexer metadata
    postgres-database: indexer
    # -- Specify a plain text username to authenticate with Postgres
    postgres-username: null
    # -- (not recommended) Specify a plain text password to authenticate with Postgres. Instead, we recommend using a Kubernetes Secret and secretEnv to mount the value as an environment variable.
    postgres-password: null
    # -- Port that Postgres is available on
    postgres-port: 5432
    # -- (not recommended) Specify a plain text mnemonic for your operator account. Instead, we recommend using a Kubernetes Secret and secretEnv to mount the value as an environment variable.
    mnemonic: null
    # -- (required) An endpoint to query the network subgraph
    network-subgraph-endpoint: null
  configTemplate: |
    WARNING: This shows all the possible configuration options. Make sure you know what
    #           you are doing.
    #           Prefer starting with `minimal-config-example.toml`.
    #
    # All the optional values (missing from the minimal config) are set to the current
    # default values.
    # You will have to change *most* the values below to match your setup.
    #
    # Some of the config below are global graph network values, which you can find here:
    # https://github.com/graphprotocol/indexer/tree/main/docs/networks
    #
    # Pro tip: if you need to load some values from the environment into this config, you
    # can overwrite with environment variables. For example, the following can be replaced
    # by [PREFIX]_DATABASE_POSTGRESURL, where PREFIX can be `INDEXER_SERVICE` or `TAP_AGENT`:
    #
    # [database]
    # postgres_url = "postgresql://indexer:${POSTGRES_PASSWORD}@postgres:5432/indexer_components_0"

    [indexer]
    indexer_address = "{{ .Values.indexerDefaults.config['indexer-address'] | default "0xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" }}"
    operator_mnemonic = "{{ .Values.indexerDefaults.config.mnemonic | default "some cool words that turn into money" }}"

    [metrics]
    port = {{ .Values.metrics.port | default 7602 }}

    [database]
    postgres_url = "postgresql://{{ .Values.indexerDefaults.config['postgres-username'] | default "username" }}:{{ .Values.indexerDefaults.config['postgres-password'] | default "password" }}@{{ .Values.indexerDefaults.config['postgres-host'] | default "postgres-agent" }}:{{ .Values.indexerDefaults.config['postgres-port'] | default 5432 }}/{{ .Values.indexerDefaults.config['postgres-database'] | default "agent_db" }}"
    postgres_url = "postgresql://{{ env "POSTGRES_USERNAME" }}:{{ env "POSTGRES_PASSWORD" }}@{{ .Values.indexerDefaults.config['postgres-host'] | default "postgres-agent" }}:{{ .Values.indexerDefaults.config['postgres-port'] | default 5432 }}/{{ .Values.indexerDefaults.config['postgres-database'] | default "agent_db" }}"

    [graph_node]
    query_url = "{{ .Values.indexerDefaults.config['graph-node-query-endpoint'] | default "http://query-node-0:8000" }}"
    status_url = "{{ .Values.indexerDefaults.config['graph-node-status-endpoint'] | default "http://index-node-0:8030/graphql" }}"

    [subgraphs.network]
    query_url = "{{ .Values.indexerDefaults.config['network-subgraph-endpoint'] | default "https://gateway-arbitrum.network.thegraph.com/api/supercoolAPIkey/subgraphs/id/3xQHhMudr1oh69ut36G2mbzpYmYxwqCeU6wwqyCDCnqV" }}"
    syncing_interval_secs = {{ .Values.indexerDefaults.config.subgraphs.network.syncingIntervalSecs | default 60 }}
    recently_closed_allocation_buffer_secs = {{ .Values.indexerDefaults.config.subgraphs.network.recentlyClosedAllocationBufferSecs | default 100 }}

    [subgraphs.escrow]
    query_url = "{{ .Values.indexerDefaults.config.subgraphs.escrow.queryUrl | default "https://gateway-arbitrum.network.thegraph.com/api/supercoolAPIkey/subgraphs/id/7ubx365MiqBH5iUz6XWXWT8PTof5BVAyEzdb8m17RvbD" }}"
    syncing_interval_secs = {{ .Values.subgraphs.escrow.syncingIntervalSecs | default 60 }}

    [blockchain]
    chain_id = {{ .Values.indexerDefaults.config.blockchain.chainId | default 421614 }}
    receipts_verifier_address = "{{ .Values.indexerDefaults.config.blockchain.receiptsVerifierAddress | default "0xfC24cE7a4428A6B89B52645243662A02BA734ECF" }}"

    ##############################################
    # Specific configurations to indexer-service #
    ##############################################
    [service]
    host_and_port = "{{ .Values.indexerDefaults.config.service.hostAndPort | default "0.0.0.0:7600" }}"
    url_prefix = "{{ .Values.indexerDefaults.config.service.urlPrefix | default "/" }}"
    serve_network_subgraph = {{ .Values.indexerDefaults.config.service.serveNetworkSubgraph | default false }}
    serve_escrow_subgraph = {{ .Values.indexerDefaults.config.service.serveEscrowSubgraph | default false }}

    [service.tap]
    max_receipt_value_grt = "{{ .Values.indexerDefaults.config.service.tap.maxReceiptValueGrt | default "0.001" }}"

    ########################################
    # Specific configurations to tap-agent #
    ########################################
    [tap]
    max_amount_willing_to_lose_grt = "{{ .Values.indexerDefaults.config.tap.maxAmountWillingToLoseGrt | default "0.03" }}"

    [tap.rav_request]
    trigger_value_divisor = {{ .Values.indexerDefaults.config.tap.ravRequest.triggerValueDivisor | default 3 }}
    timestamp_buffer_secs = {{ .Values.indexerDefaults.config.tap.ravRequest.timestampBufferSecs | default 60 }}
    request_timeout_secs = {{ .Values.indexerDefaults.config.tap.ravRequest.requestTimeoutSecs | default 5 }}
    max_receipts_per_request = {{ .Values.indexerDefaults.config.tap.ravRequest.maxReceiptsPerRequest | default 1000 }}

    [tap.sender_aggregator_endpoints]
    {{- range $key, $value := .Values.indexerDefaults.config.tap.senderAggregatorEndpoints }}
    {{ $key }} = "{{ $value }}"
    {{- end }}



  env: {}

  secretEnv: 
    secretEnv:
      PRIMARY_SUBGRAPH_DATA_PGUSER:
        # -- Name of the secret that contains your PG username
        secretName:
        # -- Name of the data key in the secret that contains your PG username
        key:
      PRIMARY_SUBGRAPH_DATA_PGPASSWORD:
        # -- Name of the secret that contains your PG password
        secretName:
        # -- Name of the data key in the secret that contains your PG password
        key:
      INDEXER_OPERATOR_MNEMONIC:
        # -- Name of the secret that contains your Operator mnemonic
        secretName:
        # -- Name of the data key in the secret that contains your Operator mnemonic
        key:


indexerAgent:
  # -- Image for indexer-agent
  image:
    repository: ghcr.io/graphprotocol/indexer-agent
    pullPolicy: IfNotPresent
    tag: "v0.21.3"

  # -- Config to be supplied as CLI arguments, specified using YAML keys to allow overriding
  config:
    # -- (required) URL for your graph-node admin API endpoint
    graph-node-admin-endpoint: null
    # -- (required) Public HTTPS URL of your indexer-service query endpoint
    public-indexer-url: null
    # -- (required) A command separated list of graph-node Node IDs to assign subgraphs to
    index-node-ids: null
    # -- (required) The gateway collect-receipts endpoint for getting vouchers
    collect-receipts-endpoint: null
    # -- (required) Base58 deployment hash (Qm...) for the Graph Network Subgraph
    network-subgraph-deployment: null
    # -- (required) Contract address of ERC20 used for DAI variable in cost models
    dai-contract: null
    # -- (optional) Query endpoint for syncing status of EBO and its contract state.
    epoch-subgraph-endpoint: null

  env: {}

  secretEnv: {}

  # -- Additional CLI arguments to pass to `indexer-agent`
  extraArgs: []

  # Increasing the grace termination period prevents Kubernetes
  # from killing the node process prematurely. Premature shutdown
  # can lead to data integrity issues
  # -- Amount of time to wait before force-killing the process
  terminationGracePeriodSeconds: 10

  # -- Annotations for the `Pod`
  podAnnotations: {}

  # -- Pod-wide security context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 101337
    runAsGroup: 101337
    fsGroup: 101337

  service:
    topologyAwareRouting:
      enabled: false
    type: ClusterIP
    ports: # Valid keys are names of ports that are exposed by the Pod
      # -- Service Port to expose Indexer Management API on
      http-mgmtapi: 8000
      # -- Service Port to expose Metrics on
      http-metrics: 7300

  resources: {}
    # We usually recommend not to specify default resources and to leave this as a conscious
    # choice for the user. This also increases chances charts run on environments with little
    # resources, such as Minikube. If you do want to specify resources, uncomment the following
    # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
    # limits:
    #   cpu: 100m
    #   memory: 128Mi
    #   ephemeral-storage: 100Mi
    # requests:
    #   cpu: 100m
    #   memory: 128Mi
    #   ephemeral-storage: 100Mi

  nodeSelector: {}

  tolerations: []

  affinityPresets:
    # -- Configure anti-affinity rules to prevent multiple instances on the same host
    antiAffinityByHostname: true

  affinity: {}

indexerService:
  # -- Image for indexer-service
  image:
    repository: ghcr.io/graphprotocol/indexer-service
    pullPolicy: IfNotPresent
    # -- Overrides the image tag
    # @default -- Chart.appVersion
    tag: ""

  # -- Number of replicas to run
  replicas: 1

  env: {}

  secretEnv: {}

  # -- Additional CLI arguments to pass to `indexer-service`
  extraArgs: []

  # Increasing the grace termination period prevents Kubernetes
  # from killing the node process prematurely. Premature shutdown
  # can lead to data integrity issues
  # -- Amount of time to wait before force-killing the process
  terminationGracePeriodSeconds: 10

  # -- Annotations for the `Pod`
  podAnnotations: {}

  # -- Pod-wide security context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 101337
    runAsGroup: 101337
    fsGroup: 101337

  service:
    topologyAwareRouting:
      enabled: false
    type: ClusterIP
    ports: # Valid keys are names of ports that are exposed by the Pod
      # -- Service Port to expose Query API on
      http-queryapi: 7600
      # -- Service Port to expose Metrics on
      http-metrics: 7300

  resources: {}
    # We usually recommend not to specify default resources and to leave this as a conscious
    # choice for the user. This also increases chances charts run on environments with little
    # resources, such as Minikube. If you do want to specify resources, uncomment the following
    # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
    # limits:
    #   cpu: 100m
    #   memory: 128Mi
    #   ephemeral-storage: 100Mi
    # requests:
    #   cpu: 100m
    #   memory: 128Mi
    #   ephemeral-storage: 100Mi

  nodeSelector: {}

  tolerations: []

  affinityPresets:
    # -- Configure anti-affinity rules to prevent multiple instances on the same host
    antiAffinityByHostname: true

  affinity: {}


indexerTapAgent:
  # -- Image for indexer-tap-agent
  image:
    repository: ghcr.io/graphprotocol/indexer-tap-agent
    pullPolicy: IfNotPresent
    # -- Overrides the image tag
    # @default -- Chart.appVersion
    tag: ""

  # -- Number of replicas to run
  replicas: 1

  env: {}

  secretEnv: {}

  # -- Additional CLI arguments to pass to `indexer-service`
  extraArgs: []

  # Increasing the grace termination period prevents Kubernetes
  # from killing the node process prematurely. Premature shutdown
  # can lead to data integrity issues
  # -- Amount of time to wait before force-killing the process
  terminationGracePeriodSeconds: 10

  # -- Annotations for the `Pod`
  podAnnotations: {}

  # -- Pod-wide security context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 101337
    runAsGroup: 101337
    fsGroup: 101337

  service:
    topologyAwareRouting:
      enabled: false
    type: ClusterIP
    ports: # Valid keys are names of ports that are exposed by the Pod
      # -- Service Port to expose Query API on
      http-queryapi: 7600
      # -- Service Port to expose Metrics on
      http-metrics: 7300

  resources: {}
    # We usually recommend not to specify default resources and to leave this as a conscious
    # choice for the user. This also increases chances charts run on environments with little
    # resources, such as Minikube. If you do want to specify resources, uncomment the following
    # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
    # limits:
    #   cpu: 100m
    #   memory: 128Mi
    #   ephemeral-storage: 100Mi
    # requests:
    #   cpu: 100m
    #   memory: 128Mi
    #   ephemeral-storage: 100Mi

  nodeSelector: {}

  tolerations: []

  affinityPresets:
    # -- Configure anti-affinity rules to prevent multiple instances on the same host
    antiAffinityByHostname: true

  affinity: {}

